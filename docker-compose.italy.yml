services:
  embassy-eye-italy:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile.italy
    container_name: embassy-eye-italy
    # IMPORTANT: Use host network mode to match local behavior
    # This ensures Chrome sees the same network fingerprint as local execution
    # Critical for reCAPTCHA Enterprise validation
    network_mode: "host"
    # CRITICAL: Increase shared memory size for Chrome
    # Chrome needs large /dev/shm for reCAPTCHA Enterprise to work properly
    # Default Docker /dev/shm is 64MB, which is too small
    shm_size: 2gb
    # Security options - allow Chrome to run properly
    security_opt:
      - seccomp=unconfined  # Required for Chrome sandbox alternatives
    # Capabilities needed for Chrome
    cap_add:
      - SYS_ADMIN  # Required for Chrome sandbox
    # Environment variables
    environment:
      # Telegram configuration - set these in .env file or override here
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_USER_ID=${TELEGRAM_USER_ID}
      # Italy login credentials
      - ITALY_EMAIL=${ITALY_EMAIL}
      - ITALY_PASSWORD=${ITALY_PASSWORD}
      # Alternative env var names (for compatibility)
      - LOGIN_EMAIL=${ITALY_EMAIL}
      - LOGIN_PASSWORD=${ITALY_PASSWORD}
      # Optional: Italy login URL override
      - ITALY_LOGIN_URL=${ITALY_LOGIN_URL:-https://prenotami.esteri.it/}
      # Optional: Proxy configuration
      - PROXY_SERVER=${PROXY_SERVER:-}
      - PROXY_USERNAME=${PROXY_USERNAME:-}
      - PROXY_PASSWORD=${PROXY_PASSWORD:-}
      # Headless mode (set to false for better reCAPTCHA Enterprise compatibility)
      # reCAPTCHA Enterprise often fails in headless mode
      # If you must use headless, set ITALY_HEADLESS=true
      - ITALY_HEADLESS=${ITALY_HEADLESS:-false}
      # Timezone (should match Dockerfile, but can be overridden)
      - TZ=Europe/Rome
      # Locale
      - LANG=it_IT.UTF-8
      - LC_ALL=it_IT.UTF-8
    env_file:
      - .env
    volumes:
      # Mount screenshots directory to persist HTML files
      - ./screenshots:/app/screenshots
      # Mount project root to persist any state files
      - .:/app
    # Uncomment to run on a schedule (requires cron or similar)
    # restart: unless-stopped
    # For interactive mode (keeps browser open for inspection)
    stdin_open: true
    tty: true

